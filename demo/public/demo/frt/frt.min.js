import e from"../../dist/index.mjs";let inputMaxOrders=document.getElementById("inputRuns"),btnSetMaxOrdersInf=document.getElementById("btnSetRunsInf"),inputMeasureAfterX=document.getElementById("inputAmount"),enableOrderLog=document.getElementById("enableOrderLog"),btnStartStop=document.getElementById("btnStartStop"),enableRawData=document.getElementById("enableRawData"),rawData=document.getElementById("rawData"),rawDataTable=document.getElementById("rawDataTable"),countRun=document.getElementById("countRun"),resultAvgStoreIQ=document.getElementById("resultStorageIQ"),resultAvgWebStorage=document.getElementById("resultWebstorage"),resultAvgIndexedDB=document.getElementById("resultIndexDB");btnSetMaxOrdersInf?.addEventListener("click",()=>{btnSetMaxOrdersInf.classList.contains("disabled")?(btnSetMaxOrdersInf.classList.remove("disabled"),inputMaxOrders.disabled=!0,btnSetMaxOrdersInf.classList.add("enabled")):(btnSetMaxOrdersInf.classList.remove("enabled"),inputMaxOrders.disabled=!1,btnSetMaxOrdersInf.classList.add("disabled"))}),enableRawData?.addEventListener("click",()=>{enableRawData.checked?rawData.classList.remove("hidden"):rawData.classList.add("hidden")}),btnStartStop?.addEventListener("click",()=>{btnStartStop.classList.contains("disabled")?(stopTest=!0,btnStartStop.classList.remove("disabled"),btnStartStop.classList.add("enabled"),btnStartStop.innerText="Start"):(stopTest=!1,btnStartStop.classList.remove("enabled"),btnStartStop.classList.add("disabled"),btnStartStop.innerText="Stop",startTest())}),countRun.addEventListener("click",async()=>{countRun.innerText="Reset...",countRun.style.backgroundColor="red",await storeIQ.start(),await reset(),countRun.style.height="4rem",countRun.innerText="Reload Page!",countRun.style.backgroundColor="green"});var stopTest=!1;let storeIQ=new e;async function reset(){localStorage.clear(),indexedDB.deleteDatabase("test"),sessionStorage.clear(),await storeIQ.delete()}async function startTest(){await storeIQ.start(),storeIQ.onError=e=>{console.error(e)},await reset();let e=0,t=inputMaxOrders.value,n=btnSetMaxOrdersInf.classList.contains("enabled"),r=inputMeasureAfterX.value,a=[],s={storeIQ:0,webStorage:0,indexedDB:0},o=new Map;for(;(t-- >0||n)&&!stopTest;){let{orders:l,simulation:d}=await generateOrders(r,o);o=d,countRun.innerText=e+++1,enableOrderLog.checked&&console.log(l,d);let i=await testStoreIQ(l);s.storeIQ+=i;let c=await testWebStorage(l);s.webStorage+=c;let u=await testIndexedDB(l);if(s.indexedDB+=u,a.push({storeIQ:i,webStorage:c,indexedDB:u}),resultAvgStoreIQ.innerText=(s.storeIQ/a.length).toFixed(2),resultAvgWebStorage.innerText=(s.webStorage/a.length).toFixed(2),resultAvgIndexedDB.innerText=(s.indexedDB/a.length).toFixed(2),rawDataTable){let g=rawDataTable.insertRow(-1),b=g.insertCell(0),x=g.insertCell(1),p=g.insertCell(2),I=g.insertCell(3);b.innerText=e,x.innerText=i.toFixed(2),p.innerText=c.toFixed(2),I.innerText=u.toFixed(2)}}}async function testStoreIQ(e){let t=performance.now();for(let n=0;n<e.length;n++){let r=e[n];switch(r.type){case"set":storeIQ.setItem(`s_${r.key}`,r.value);break;case"get":let a=await storeIQ.getItem(`s_${r.key}`);a!==r.expected&&console.error(`{${n}} Expected ${r.expected} but got ${a}`);break;case"delete":storeIQ.removeItem(`s_${r.key}`)}}let s=performance.now();return s-t}async function testWebStorage(e){let t=performance.now();for(let n=0;n<e.length;n++){let r=e[n];switch(r.type){case"set":localStorage.setItem(`w_${r.key}`,JSON.stringify(r.value));break;case"get":let a=JSON.parse(localStorage.getItem(`w_${r.key}`));a!=r.expected&&console.error(`{${n}} Expected ${r.expected} but got ${a}`);break;case"delete":localStorage.removeItem(`w_${r.key}`)}}let s=performance.now();return s-t}async function testIndexedDB(e){return new Promise((t,n)=>{let r=indexedDB.open("test",1);r.onupgradeneeded=function(){let e=r.result;e.createObjectStore("data")},r.onsuccess=function(){let n=r.result,a=n.transaction("data","readwrite"),s=a.objectStore("data"),o=performance.now();executeIndexedDBOrder(e,s).then(()=>{a.commit()}),a.oncomplete=function(){let e=performance.now();n.close(),t(e-o)}}})}async function executeIndexedDBOrder(e,t){var n=0;for(let r of e)new Promise((e,a)=>{let s=n++;switch(r.type){case"set":t.put(r.value,`i_${r.key}`).onsuccess=function(){e()};break;case"get":let o=t.get(`i_${r.key}`);o.onsuccess=function(){o.result==r.expected||void 0===o.result&&null===r.expected||console.error(`{${s}} Expected ${r.expected} but got ${o.result}`),e()};break;case"delete":let l=t.delete(`i_${r.key}`);l.onsuccess=function(){e()}}})}async function generateOrders(e,t=new Map){let n=[];for(let r=0;r<e;r++){let a=Math.random();if(a<.5){let s=Math.floor(100*Math.random()),o=generateData();n.push({type:"set",key:s,value:o}),t.set(s,o)}else if(a<.8){let l=Math.floor(100*Math.random()),d=t.get(l);n.push({type:"get",key:l,expected:d||null})}else{let i=Math.floor(100*Math.random());n.push({type:"delete",key:i}),t.delete(i)}}return{orders:n,simulation:t}}function generateData(e=0){var t=Math.random();if(t<.4){var n=Math.floor(1e3*Math.random());return generateString(n)}if(t<.6)return Math.random()*Number.MAX_SAFE_INTEGER;if(t<.8||e>5){var n=Math.floor(100*Math.random());return{data:generateString(n)}}var n=Math.floor(5*Math.random());return[...Array(n)].map(()=>generateData(e+1))}function generateString(e){let t=[...Array(e)],n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let r=0;r<e;r++)t[r]=n.charAt(Math.floor(Math.random()*n.length));return t.join("")}